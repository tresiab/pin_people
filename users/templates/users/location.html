{% extends "base.html" %}

{% load static %}

{% block title %}User Locations{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
    /* 70% of the screen height */
    #map { height: 70vh; }
</style>
{% endblock %}

{% block content %}
<h2 class="section-header">Users Locations</h2>
<div id="map"></div>

<!-- Safe JSON embedding -->
{{ users|json_script:"user-data" }}
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([20, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors',
        noWrap: true,
        worldCopyJump: false
    }).addTo(map);

    var userIcon = L.icon({
        iconUrl: "{% static 'images/user-icon.png' %}",
        iconSize: [40, 40], // adjust size
        iconAnchor: [20, 40], // point of the icon which will correspond to marker's location
        popupAnchor: [0, -40] // where the popup should open relative to the iconAnchor
    });

    let data = {{ users_json|safe }};
    let loggedInUserId = {{ logged_in_user_id }};
    let isSuperuser = {{ is_superuser|yesno:"true,false" }};

    data.forEach(u => {
        if (u.latitude && u.longitude) {
            // Start building popup content
            let popupContent = `
                <div style="text-align:center;">
                    <strong>${u.username}</strong><br>
                    <small>${u.position}</small><br>
                </div>
            `;

            // Add profile link if superuser or popup is current user
            if (isSuperuser || u.id === loggedInUserId) {
                popupContent += `<a href="/users/${u.id}/">View Profile</a><br>`;
            }

            // Add marker with custom popup
            L.marker([u.latitude, u.longitude], {icon: userIcon})
                .addTo(map)
                .bindPopup(popupContent);
        }
    });
</script>
{% endblock %}
